<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lyrics Sincronizados</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #audio_player {
            margin: 20px auto;
            width: 300px;
        }
        #lyrics {
            margin: 20px auto;
            width: 300px;
            text-align: left;
            font-size: 16px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .highlight {
            background-color: yellow;
            transition: background-color 0.5s ease-in-out;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<audio id="audio_player" controls>
    <source src="/uploads/{{ audio_file }}" type="audio/mp3">
    Tu navegador no soporta el elemento de audio.
</audio>
<div id="lyrics"></div>

<script>
    let audioPlayer = document.getElementById('audio_player');
    let lyricsDiv = document.getElementById('lyrics');
    const transcription = {{ transcription | tojson }};
    let currentWordIndex = [-1, -1];

    document.addEventListener('DOMContentLoaded', function() {
        if (transcription && transcription.segments) {
            displayLyrics();
            showInitialSegment();
            syncLyrics();
        } else {
            console.error('Transcripción no encontrada o formato incorrecto.');
        }
    });

    function displayLyrics() {
        lyricsDiv.innerHTML = '';
        transcription.segments.forEach((segment, segmentIndex) => {
            let segmentDiv = document.createElement('div');
            segmentDiv.id = `segment-${segmentIndex}`;
            segmentDiv.classList.add('hidden'); // Ocultar todos los segmentos inicialmente
            segment.words.forEach((word, wordIndex) => {
                let span = document.createElement('span');
                span.id = `word-${wordIndex}-${segmentIndex}`;
                span.textContent = word.word + ' ';
                segmentDiv.appendChild(span);
            });
            lyricsDiv.appendChild(segmentDiv);
        });
    }

    function showInitialSegment() {
        if (transcription.segments.length > 0) {
            document.getElementById(`segment-0`).classList.remove('hidden');
        }
    }

    function syncLyrics() {
        audioPlayer.addEventListener('timeupdate', function() {
            let currentTime = audioPlayer.currentTime;
            for (let i = 0; i < transcription.segments.length; i++) {
                let words = transcription.segments[i].words;
                for (let j = 0; j < words.length; j++) {
                    let word = words[j];
                    if (currentTime >= word.start && currentTime <= word.end) {
                        if (currentWordIndex[0] !== j || currentWordIndex[1] !== i) {
                            // Mantener resaltadas las palabras anteriores y ocultar los segmentos innecesarios
                            if (currentWordIndex[0] !== -1 && currentWordIndex[1] !== -1) {
                                let [prevWordIndex, prevSegmentIndex] = currentWordIndex;
                                // No quitar el resaltado de las palabras anteriores, pero ocultar sus segmentos
                                for (let k = 0; k < 3; k++) {
                                    let nextWordSpan = getNextWordSpan(prevWordIndex, prevSegmentIndex, k);
                                    if (nextWordSpan) {
                                        let [_, nextSegmentIndex] = nextWordSpan.id.split('-').slice(2).map(Number);
                                        let segmentElement = document.getElementById(`segment-${nextSegmentIndex}`);
                                        if (segmentElement && nextSegmentIndex !== i && nextSegmentIndex !== currentWordIndex[1]) {
                                            segmentElement.classList.add('hidden');
                                        }
                                    }
                                }
                            }

                            // Añadir el resaltado a la palabra actual y mostrar el segmento actual
                            document.getElementById(`word-${j}-${i}`).classList.add('highlight');
                            document.getElementById(`segment-${i}`).classList.remove('hidden');

                            // Añadir el resaltado a las siguientes dos palabras, si existen, y mostrar sus segmentos correspondientes
                            for (let k = 1; k <= 2; k++) {
                                let nextWordSpan = getNextWordSpan(j, i, k);
                                if (nextWordSpan) {
                                    nextWordSpan.classList.add('highlight');
                                    let [_, nextSegmentIndex] = nextWordSpan.id.split('-').slice(2).map(Number);
                                    let segmentElement = document.getElementById(`segment-${nextSegmentIndex}`);
                                    if (segmentElement) {
                                        segmentElement.classList.remove('hidden');
                                    }
                                }
                            }

                            // Actualizar el índice de la palabra actual
                            currentWordIndex = [j, i];
                        }
                        return; // Salir del bucle una vez encontrada la palabra actual
                    }
                }
            }
        });
    }

    // Obtener el span de la palabra que está "offset" posiciones adelante
    function getNextWordSpan(currentWordIndex, currentSegmentIndex, offset) {
        let segment = transcription.segments[currentSegmentIndex];
        let remainingWordsInCurrentSegment = segment.words.length - currentWordIndex - 1;

        // Si la palabra con el desplazamiento está en el mismo segmento
        if (offset <= remainingWordsInCurrentSegment) {
            return document.getElementById(`word-${currentWordIndex + offset}-${currentSegmentIndex}`);
        }
        // Ajustar el offset y pasar al siguiente segmento
        else {
            offset -= remainingWordsInCurrentSegment + 1;
            let nextSegmentIndex = currentSegmentIndex + 1;

            while (nextSegmentIndex < transcription.segments.length) {
                let nextSegment = transcription.segments[nextSegmentIndex];
                if (offset < nextSegment.words.length) {
                    return document.getElementById(`word-${offset}-${nextSegmentIndex}`);
                }
                offset -= nextSegment.words.length;
                nextSegmentIndex++;
            }
        }
        // Si no hay más palabras en los siguientes segmentos
        return null;
    }
</script>

</body>
</html>
